<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Media Kit</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/media_kit_edit.css' %}">
</head>
<body>
    <div class="media-kit-container">
        <div class="nav-links">
            <a href="#">Campaigns</a>
            <a href="#">FAQ</a>
            <a href="#">Contact</a>
        </div>

        <!-- Profile Section -->
        <form method="post" enctype="multipart/form-data" class="section-form" id="profile-form">
            {% csrf_token %}
            <input type="hidden" name="section" value="profile">
            <section class="card">
                <div class="card-header" onclick="toggleSection(this)">
                    <h2>Edit Media Kit Information</h2>
                    <div class="arrow">
                        <svg viewBox="0 0 24 24">
                            <polyline points="6 9 12 15 18 9"></polyline>
                        </svg>
                    </div>
                </div>
                <div class="card-content">
                    <div class="profile-details">
                        <div class="form-group">
                            <label for="{{ media_kit_form.name.id_for_label }}">Name</label>
                            {{ media_kit_form.name }}
                        </div>
                        <div class="form-group">
                            <label for="{{ media_kit_form.username.id_for_label }}">Username</label>
                            {{ media_kit_form.username }}
                        </div>
                        <div class="form-group">
                            <label for="{{ media_kit_form.location.id_for_label }}">Location</label>
                            {{ media_kit_form.location }}
                        </div>
                        <div class="form-group">
                            <label for="{{ media_kit_form.bio.id_for_label }}">Bio</label>
                            {{ media_kit_form.bio }}
                        </div>
                        <div class="form-group">
                            <label for="{{ media_kit_form.url_slug.id_for_label }}">Custom URL</label>
                            <div class="url-slug-input">
                                <span class="url-prefix">mediakit/</span>
                                {{ media_kit_form.url_slug }}
                            </div>
                            {% if media_kit_form.url_slug.errors %}
                                <div class="error">{{ media_kit_form.url_slug.errors }}</div>
                            {% endif %}
                        </div>
                        <div class="form-group checkbox-group">
                            <label for="{{ media_kit_form.show_offering_price.id_for_label }}" class="checkbox-label">
                                {{ media_kit_form.show_offering_price }}
                                <span>Show offering prices on media kit</span>
                            </label>
                            {% if media_kit_form.show_offering_price.errors %}
                                <div class="error">{{ media_kit_form.show_offering_price.errors }}</div>
                            {% endif %}
                        </div>
						<div class="form-group checkbox-group">
                            <label for="{{ media_kit_form.show_public.id_for_label }}" class="checkbox-label">
                                {{ media_kit_form.show_public }}
                                <span>Show media kit in public database</span>
                            </label>
                            {% if media_kit_form.show_public.errors %}
                                <div class="error">{{ media_kit_form.show_public.errors }}</div>
                            {% endif %}
                        </div>
                        <div class="form-group">
                            <label>Tags</label>
                            <div id="tagContainer" class="tag-container">
                                {% for tag in media_kit.tags.all %}
                                    <span class="tag">
                                        {{ tag.name }}
                                        <button type="button" class="tag-delete" data-tag-id="{{ tag.id }}">×</button>
                                    </span>
                                {% endfor %}
                                <input type="text" id="tagInput" class="tag-input" placeholder="Add tags...">
                                <input type="hidden" name="tags" value="{{ media_kit.tags.all|join:',' }}">
                            </div>
                        </div>
                    </div>
                    <div class="profile-edit">
                        <div class="form-group">
                            <label for="{{ media_kit_form.profile_photo.id_for_label }}">Profile Photo</label>
                            {% if media_kit.profile_photo %}
                                <div class="current-file">Current: <a href="{{ media_kit.profile_photo.url }}" target="_blank">{{ media_kit.profile_photo.name }}</a></div>
                            {% endif %}
                            {{ media_kit_form.profile_photo }}
                            {% if media_kit_form.profile_photo.errors %}
                                <div class="error">{{ media_kit_form.profile_photo.errors }}</div>
                            {% endif %}
                        </div>
                        <div class="form-group">
                            <label for="{{ media_kit_form.banner_image.id_for_label }}">Banner Image</label>
                            {% if media_kit.banner_image %}
                                <div class="current-file">Current: <a href="{{ media_kit.banner_image.url }}" target="_blank">{{ media_kit.banner_image.name }}</a></div>
                            {% endif %}
                            {{ media_kit_form.banner_image }}
                            {% if media_kit_form.banner_image.errors %}
                                <div class="error">{{ media_kit_form.banner_image.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="submit" class="save-button">Save Profile</button>
                </div>
            </section>
        </form>

        <!-- Brand Partners Section -->
        <form method="post" enctype="multipart/form-data" class="section-form" id="brand-partners-form">
            {% csrf_token %}
            <input type="hidden" name="section" value="brand_partners">
            {{ brand_partner_formset.management_form }}
            <section class="card">
                <div class="card-header" onclick="toggleSection(this)">
                    <h2>Brand Partners</h2>
                    <div class="arrow">
                        <svg viewBox="0 0 24 24">
                            <polyline points="6 9 12 15 18 9"></polyline>
                        </svg>
                    </div>
                </div>
                <div class="card-content">
                    <div class="partners-container">
                        {% for form in brand_partner_formset %}
                            <div class="partner-row" data-row-id="{{ forloop.counter }}">
                                {% if not forloop.first %}
                                    <div class="separator"></div>
                                {% endif %}
                                {{ form.id }}
                                <div class="partner-content">
                                    <div class="partner-fields">
                                        <div class="form-group">
                                            <label for="{{ form.name.id_for_label }}">Brand Name</label>
                                            {{ form.name }}
                                            {% if form.name.errors %}
                                                <div class="error">{{ form.name.errors }}</div>
                                            {% endif %}
                                        </div>
                                        <div class="form-group">
                                            <label for="{{ form.logo.id_for_label }}">Brand Logo</label>
                                            {{ form.logo }}
                                            {% if form.logo.errors %}
                                                <div class="error">{{ form.logo.errors }}</div>
                                            {% endif %}
                                        </div>
                                        <div class="form-group">
                                            <label for="{{ form.integration_url.id_for_label }}">Integration URL</label>
                                            {{ form.integration_url }}
                                            {% if form.integration_url.errors %}
                                                <div class="error">{{ form.integration_url.errors }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <button type="button" class="delete-brand-partner-button" data-row-id="{{ forloop.counter }}">
                                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M3 6H5H21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                            <path d="M19 6V20C19 20.5304 18.7893 21.0391 18.4142 21.4142C18.0391 21.7893 17.5304 22 17 22H7C6.46957 22 5.96086 21.7893 5.58579 21.4142C5.21071 21.0391 5 20.5304 5 20V6M8 6V4C8 3.46957 8.21071 2.96086 8.58579 2.58579C8.96086 2.21071 9.46957 2 10 2H14C14.5304 2 15.0391 2.21071 15.4142 2.58579C15.7893 2.96086 16 3.46957 16 4V6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                        <span class="sr-only">Delete partner</span>
                                    </button>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" id="add-brand-partner-button" class="add-button">Add New Brand Partner</button>
                    <button type="submit" class="save-button">Save Brand Partners</button>
                </div>
            </section>
        </form>

        <!-- Social Platforms Section -->
        <form method="post" enctype="multipart/form-data" class="section-form" id="social-platforms-form">
            {% csrf_token %}
            <input type="hidden" name="section" value="social_platforms">
            {{ social_platform_formset.management_form }}
            <section class="card">
                <div class="card-header" onclick="toggleSection(this)">
                    <h2>Social Platforms</h2>
                    <div class="arrow">
                        <svg viewBox="0 0 24 24">
                            <polyline points="6 9 12 15 18 9"></polyline>
                        </svg>
                    </div>
                </div>
                <div class="card-content" id="social-platforms-container">
                    {% for form in social_platform_formset %}
                        <div class="form-row social-platform-row" data-row-id="{{ forloop.counter }}">
                            {{ form.id }}
                            <div class="form-group">
                                <label for="{{ form.platform.id_for_label }}">Platform</label>
                                {{ form.platform }}
                            </div>
                            
                            <!-- Platform Stats -->
                            <div class="form-group">
                                <label for="{{ form.followers.id_for_label }}">Followers</label>
                                {{ form.followers }}
                            </div>
                            <div class="form-group">
                                <label for="{{ form.engagement_rate.id_for_label }}">Engagement Rate (%)</label>
                                {{ form.engagement_rate }}
                            </div>
                            <div class="form-group">
                                <label for="{{ form.average_views.id_for_label }}">Average Views</label>
                                {{ form.average_views }}
                            </div>

                            <!-- Audience Demographics -->
                            <div class="form-group">
                                <label for="{{ form.male_percentage.id_for_label }}">Male Percentage (%)</label>
                                {{ form.male_percentage }}
                            </div>
                            <div class="form-group">
                                <label for="{{ form.female_percentage.id_for_label }}">Female Percentage (%)</label>
                                {{ form.female_percentage }}
                            </div>

                            <!-- Age Distribution -->
                            <div class="form-group">
                                <label for="{{ form.age_18_34_percentage.id_for_label }}">Age 18-34 (%)</label>
                                {{ form.age_18_34_percentage }}
                            </div>
                            <div class="form-group">
                                <label for="{{ form.age_35_44_percentage.id_for_label }}">Age 35-44 (%)</label>
                                {{ form.age_35_44_percentage }}
                            </div>
                            <div class="form-group">
                                <label for="{{ form.age_45_54_percentage.id_for_label }}">Age 45-54 (%)</label>
                                {{ form.age_45_54_percentage }}
                            </div>
                            <div class="form-group">
                                <label for="{{ form.age_55_64_percentage.id_for_label }}">Age 55-64 (%)</label>
                                {{ form.age_55_64_percentage }}
                            </div>
                            <div class="form-group">
                                <label for="{{ form.age_65_plus_percentage.id_for_label }}">Age 65+ (%)</label>
                                {{ form.age_65_plus_percentage }}
                            </div>

                            <!-- Top Countries -->
                            <div class="form-group">
                                <label for="{{ form.top_country_1.id_for_label }}">Top Country 1</label>
                                {{ form.top_country_1 }}
                            </div>
                            <div class="form-group">
                                <label for="{{ form.top_country_1_percentage.id_for_label }}">Top Country 1 Percentage (%)</label>
                                {{ form.top_country_1_percentage }}
                            </div>
                            <div class="form-group">
                                <label for="{{ form.top_country_2.id_for_label }}">Top Country 2</label>
                                {{ form.top_country_2 }}
                            </div>
                            <div class="form-group">
                                <label for="{{ form.top_country_2_percentage.id_for_label }}">Top Country 2 Percentage (%)</label>
                                {{ form.top_country_2_percentage }}
                            </div>
                            <div class="form-group">
                                <label for="{{ form.top_country_3.id_for_label }}">Top Country 3</label>
                                {{ form.top_country_3 }}
                            </div>
                            <div class="form-group">
                                <label for="{{ form.top_country_3_percentage.id_for_label }}">Top Country 3 Percentage (%)</label>
                                {{ form.top_country_3_percentage }}
                            </div>

                            <!-- Example URLs -->
                            <div class="form-group">
                                <label for="{{ form.example_url_1.id_for_label }}">Example URL 1</label>
                                {{ form.example_url_1 }}
                            </div>
                            <div class="form-group">
                                <label for="{{ form.example_url_2.id_for_label }}">Example URL 2</label>
                                {{ form.example_url_2 }}
                            </div>
                            <div class="form-group">
                                <label for="{{ form.example_url_3.id_for_label }}">Example URL 3</label>
                                {{ form.example_url_3 }}
                            </div>

                            <button type="button" class="delete-platform-button" data-row-id="{{ forloop.counter }}">Delete</button>
                        </div>
                    {% endfor %}
                    <div class="form-actions">
                        <button type="button" id="add-platform-button" class="add-button">Add New Platform</button>
                        <button type="submit" class="save-button">Save Social Platforms</button>
                    </div>
                </div>
            </section>
        </form>

        <!-- Work With Me Section -->
        <form method="post" enctype="multipart/form-data" class="section-form" id="work-with-me-form">
            {% csrf_token %}
            <input type="hidden" name="section" value="work_with_me">
            {{ work_with_me_formset.management_form }}
            <section class="card">
                <div class="card-header" onclick="toggleSection(this)">
                    <h2>Work With Me</h2>
                    <div class="arrow">
                        <svg viewBox="0 0 24 24">
                            <polyline points="6 9 12 15 18 9"></polyline>
                        </svg>
                    </div>
                </div>
                <div class="card-content" id="work-with-me-container">
                    {% for form in work_with_me_formset %}
                        <div class="service-card" data-row-id="{{ forloop.counter }}">
                            {{ form.id }}
                            <div class="service-card-header">
                                <div class="service-card-grid">
                                    <div class="form-group">
                                        <label for="{{ form.platform.id_for_label }}">Platform</label>
                                        {{ form.platform }}
                                    </div>
                                    <div class="form-group">
                                        <label for="{{ form.offering.id_for_label }}">Offering</label>
                                        {{ form.offering }}
                                    </div>
                                </div>
                            </div>
                            <div class="service-card-content">
                                <div class="form-group">
                                    <label for="{{ form.service_description.id_for_label }}">Service Description</label>
                                    {{ form.service_description }}
                                </div>
                                <div class="service-card-grid-three">
                                    <div class="form-group">
                                        <label for="{{ form.price.id_for_label }}">Price</label>
                                        {{ form.price }}
                                    </div>
                                    <div class="form-group">
                                        <label for="{{ form.number_of_deliverables.id_for_label }}">Number of Deliverables</label>
                                        {{ form.number_of_deliverables }}
                                    </div>
                                    <div class="form-group">
                                        <label for="{{ form.length_of_deliverables.id_for_label }}">Length (seconds)</label>
                                        {{ form.length_of_deliverables }}
                                    </div>
                                </div>
                            </div>
                            <div class="service-card-footer">
                                <button type="button" class="delete-offering-button" data-row-id="{{ forloop.counter }}">
                                    <svg viewBox="0 0 24 24" width="16" height="16">
                                        <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    {% endfor %}
                </div>
                <div class="form-actions">
                    <button type="button" id="add-offering-button" class="add-button">
                        <svg class="plus-icon" viewBox="0 0 24 24" width="16" height="16">
                            <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        Add New Offering
                    </button>
                    <button type="submit" class="save-button">Save Work With Me</button>
                </div>
            </section>
        </form>

        <!-- Gallery Section -->
        <form method="post" enctype="multipart/form-data" class="section-form" id="gallery-form">
            {% csrf_token %}
            <input type="hidden" name="section" value="gallery">
            {{ gallery_formset.management_form }}
            <section class="card gallery-section">
                <div class="card-header" onclick="toggleSection(this)">
                    <h2>Gallery</h2>
                    <div class="arrow">
                        <svg viewBox="0 0 24 24">
                            <polyline points="6 9 12 15 18 9"></polyline>
                        </svg>
                    </div>
                </div>
                <div class="card-content" id="gallery-container">
                    {% for form in gallery_formset %}
                        <div class="gallery-card" data-row-id="{{ forloop.counter }}">
                            {{ form.id }}
                            <div class="gallery-grid">
                                <!-- Platform -->
                                <div class="form-group">
                                    <label for="{{ form.platform.id_for_label }}">Platform</label>
                                    <div class="platform-display">
                                        <span class="platform-icon" data-platform="{{ form.platform.value|default:'' }}"></span>
                                        {{ form.platform }}
                                    </div>
                                </div>

                                <!-- Content URL -->
                                <div class="form-group url-group">
                                    <label for="{{ form.example_url.id_for_label }}">Content URL</label>
                                    <div class="url-container">
                                        {{ form.example_url }}
                                        <button type="button" class="copy-button" title="Copy URL">
                                            <svg viewBox="0 0 24 24" width="16" height="16">
                                                <path d="M8 4v12a2 2 0 002 2h8a2 2 0 002-2V7.242a2 2 0 00-.602-1.43L16.083 2.57A2 2 0 0014.685 2H10a2 2 0 00-2 2z" stroke="currentColor" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                            </svg>
                                        </button>
                                    </div>
                                </div>

                                <!-- Priority -->
                                <div class="form-group priority-group">
                                    <label for="{{ form.video_priority.id_for_label }}">Priority</label>
                                    <div class="priority-display">
                                        <svg viewBox="0 0 24 24" width="16" height="16">
                                            <circle cx="12" cy="12" r="10" stroke="currentColor" fill="none" stroke-width="2"/>
                                            <path d="M12 6v6l4 2" stroke="currentColor" fill="none" stroke-width="2" stroke-linecap="round"/>
                                        </svg>
                                        {{ form.video_priority }}
                                    </div>
                                </div>

                                <!-- Delete Button -->
                                <button type="button" class="delete-gallery-button" data-row-id="{{ forloop.counter }}">
                                    <svg viewBox="0 0 24 24" width="16" height="16">
                                        <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    {% endfor %}
                    <div class="gallery-actions">
                        <button type="button" id="add-gallery-button" class="add-button">Add New Gallery Item</button>
                        <button type="submit" class="save-button">Save Gallery</button>
                    </div>
                </div>
            </section>
        </form>

        <footer>
            © {% now "Y" %} Word on the Block. All rights reserved.
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const tagContainer = document.getElementById('tagContainer');
            const hiddenTagInput = document.querySelector('[name="tags"]');
            const tagInput = document.getElementById('tagInput');

            // Initialize hidden input with current tag IDs
            function updateHiddenInput() {
                const currentTags = Array.from(tagContainer.querySelectorAll('.tag'))
                    .map(tag => tag.querySelector('.tag-delete').dataset.tagId)
                    .filter(id => id);
                hiddenTagInput.value = currentTags.join(',');
                console.log('Updated hidden input:', hiddenTagInput.value); // Debug log
            }

            // Initialize on page load
            updateHiddenInput();

            // Handle tag deletion
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('tag-delete')) {
                    console.log('Delete button clicked'); // Debug log
                    const tagElement = e.target.closest('.tag');
                    if (tagElement) {
                        tagElement.remove();
                        updateHiddenInput();
                        console.log('Tag removed'); // Debug log
                    }
                }
            });

            // Handle new tag creation
            tagInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' || e.key === ',') {
                    e.preventDefault();
                    const tagName = this.value.trim();
                    if (tagName) {
                        fetch('/create-tag/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                            },
                            body: JSON.stringify({ tag_name: tagName })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                // Create new tag element
                                const tagElement = document.createElement('span');
                                tagElement.className = 'tag';
                                tagElement.innerHTML = `
                                    ${data.tag_name}
                                    <button type="button" class="tag-delete" data-tag-id="${data.tag_id}">×</button>
                                `;
                                
                                // Add to container before the input
                                tagContainer.insertBefore(tagElement, tagInput);
                                
                                // Update hidden input
                                updateHiddenInput();
                                
                                // Clear input
                                this.value = '';
                            }
                        });
                    }
                }
            });

            // Add this function to show notifications
            function showNotification(message, isSuccess = true) {
                const notification = document.createElement('div');
                notification.className = `notification ${isSuccess ? 'success' : 'error'}`;
                notification.textContent = message;
                
                // Style the notification
                notification.style.position = 'fixed';
                notification.style.top = '20px';
                notification.style.right = '20px';
                notification.style.padding = '15px 25px';
                notification.style.borderRadius = '5px';
                notification.style.backgroundColor = isSuccess ? '#4CAF50' : '#f44336';
                notification.style.color = 'white';
                notification.style.zIndex = '1000';
                notification.style.boxShadow = '0 2px 5px rgba(0,0,0,0.2)';
                
                document.body.appendChild(notification);
                
                // Remove the notification after 3 seconds
                setTimeout(() => {
                    notification.style.opacity = '0';
                    notification.style.transition = 'opacity 0.5s ease';
                    setTimeout(() => notification.remove(), 500);
                }, 3000);
            }

            // Update the form submission handler
            const forms = document.querySelectorAll('.section-form');
            forms.forEach(form => {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    // Create FormData object
                    const formData = new FormData(this);
                    
                    // Log the form data being submitted
                    console.log('Submitting form data:', {
                        section: formData.get('section'),
                        totalForms: formData.get('form-TOTAL_FORMS'),
                        formEntries: Array.from(formData.entries())
                    });
                    
                    // Get the section name
                    const section = formData.get('section');
                    
                    // Make sure management form data is included for formsets
                    if (section !== 'profile') {
                        // Get the management form prefix based on section
                        let prefix = '';
                        switch(section) {
                            case 'brand_partners':
                                prefix = 'brand_partners';
                                break;
                            case 'social_platforms':
                                prefix = 'social_platform';
                                break;
                            case 'work_with_me':
                                prefix = 'form';
                                break;
                            case 'gallery':
                                prefix = 'gallery';
                                break;
                        }
                        
                        // Make sure TOTAL_FORMS is included and correct
                        const totalForms = this.querySelectorAll(`[data-row-id]`).length;
                        if (!formData.has(`${prefix}-TOTAL_FORMS`)) {
                            formData.set(`${prefix}-TOTAL_FORMS`, totalForms);
                        }
                        
                        // Add other required management form fields if not present
                        if (!formData.has(`${prefix}-INITIAL_FORMS`)) {
                            const initialForms = this.querySelector(`[name="${prefix}-INITIAL_FORMS"]`)?.value || '0';
                            formData.set(`${prefix}-INITIAL_FORMS`, initialForms);
                        }
                        if (!formData.has(`${prefix}-MIN_NUM_FORMS`)) {
                            formData.set(`${prefix}-MIN_NUM_FORMS`, '0');
                        }
                        if (!formData.has(`${prefix}-MAX_NUM_FORMS`)) {
                            formData.set(`${prefix}-MAX_NUM_FORMS`, '1000');
                        }
                    }

                    // Debug log
                    console.log('Submitting form data:', {
                        section: section,
                        formData: Object.fromEntries(formData.entries())
                    });
                    
                    // Submit the form
                    fetch(window.location.href, {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showNotification(data.message || 'Saved successfully!');
                        } else {
                            console.error('Form errors:', data.error, data.form_errors, data.non_form_errors);
                            showNotification(data.error || 'Error saving section', false);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showNotification('Error saving section', false);
                    });
                });
            });

            document.addEventListener('click', function(e) {
                if (e.target.closest('.copy-button')) {
                    const urlInput = e.target.closest('.url-container').querySelector('input');
                    navigator.clipboard.writeText(urlInput.value);
                    showNotification('URL copied to clipboard!');
                }
            });

            // Handle Brand Partner deletion
            document.addEventListener('click', function(e) {
                if (e.target.closest('.delete-brand-partner-button')) {
                    const row = e.target.closest('.partner-row');
                    if (row) {
                        if (confirm('Are you sure you want to delete this brand partner?')) {
                            // Get the form
                            const form = document.getElementById('brand-partners-form');
                            
                            // Get the ID field before removing the row
                            const idField = row.querySelector('input[name$="-id"]');
                            const idValue = idField ? idField.value : null;
                            
                            console.log('Attempting to delete brand partner:', {
                                rowId: row.getAttribute('data-row-id'),
                                idValue: idValue,
                                formData: new FormData(form)
                            });

                            if (idValue) {
                                // Handle existing record deletion
                                const deleteField = document.createElement('input');
                                deleteField.type = 'hidden';
                                deleteField.name = `brand_partners-${row.getAttribute('data-row-id')-1}-DELETE`;
                                deleteField.value = 'on';
                                
                                const preservedIdField = document.createElement('input');
                                preservedIdField.type = 'hidden';
                                preservedIdField.name = `brand_partners-${row.getAttribute('data-row-id')-1}-id`;
                                preservedIdField.value = idValue;
                                
                                form.appendChild(preservedIdField);
                                form.appendChild(deleteField);
                                
                                // Submit form to delete existing record
                                submitFormAfterDeletion(form, row);
                            } else {
                                // For new/empty rows, just remove from DOM and update indexes
                                row.remove();
                                
                                // Update the TOTAL_FORMS count
                                const totalFormsInput = form.querySelector('[name="brand_partners-TOTAL_FORMS"]');
                                const remainingRows = form.querySelectorAll('.partner-row').length;
                                if (totalFormsInput) {
                                    totalFormsInput.value = remainingRows;
                                    console.log('Updated TOTAL_FORMS to:', remainingRows);
                                }
                                
                                // Update indexes for remaining rows
                                updateRowIndexes(form);
                            }
                        }
                    }
                }
            });

            // Helper function to update row indexes
            function updateRowIndexes(form) {
                const rows = form.querySelectorAll('.partner-row');
                rows.forEach((row, index) => {
                    row.setAttribute('data-row-id', index + 1);
                    row.querySelectorAll('[name*="brand_partners-"]').forEach(input => {
                        const oldIndex = input.name.match(/brand_partners-(\d+)-/)[1];
                        input.name = input.name.replace(
                            `brand_partners-${oldIndex}-`,
                            `brand_partners-${index}-`
                        );
                        if (input.id) {
                            input.id = input.id.replace(
                                `brand_partners-${oldIndex}-`,
                                `brand_partners-${index}-`
                            );
                        }
                    });
                });
            }

            // Helper function to submit form after deletion
            function submitFormAfterDeletion(form, row) {
                const formData = new FormData(form);
                fetch(window.location.href, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': form.querySelector('[name="csrfmiddlewaretoken"]').value
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Remove the row from the DOM only after successful save
                        row.remove();
                        
                        // Update the TOTAL_FORMS count
                        const totalFormsInput = form.querySelector('[name="brand_partners-TOTAL_FORMS"]');
                        const remainingRows = form.querySelectorAll('.partner-row').length;
                        if (totalFormsInput) {
                            totalFormsInput.value = remainingRows;
                            console.log('Updated TOTAL_FORMS to:', remainingRows);
                        }
                        
                        // Update form indexes for remaining rows
                        updateRowIndexes(form);

                        showNotification('Brand partner deleted successfully!');
                        
                        // Optionally reload the page to ensure everything is in sync
                        window.location.reload();
                    } else {
                        console.error('Error saving deletion:', data);
                        showNotification('Error deleting brand partner', false);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showNotification('Error deleting brand partner', false);
                });
            }

            // Handle Social Platform deletion
            document.addEventListener('click', function(e) {
                if (e.target.closest('.delete-platform-button')) {
                    const row = e.target.closest('.social-platform-row');
                    if (row) {
                        if (confirm('Are you sure you want to delete this platform?')) {
                            row.remove();
                            updateFormsetIndexes('social-platforms-form');
                        }
                    }
                }
            });

            // Helper function to submit Work With Me form after deletion
            function submitWorkWithMeFormAfterDeletion(form, cardToDelete) {
                const formData = new FormData(form);
                formData.set('section', 'work_with_me');

                // Add a flag to indicate this is a deletion operation
                formData.append('is_deletion', 'true');

                fetch(window.location.href, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': form.querySelector('[name="csrfmiddlewaretoken"]').value
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        cardToDelete.remove();
                        showNotification('Offering deleted successfully');
                        updateWorkWithMeIndexes(form);
                    } else {
                        console.error('Server returned error:', data);
                        showNotification(data.error || 'Error deleting offering', false);
                    }
                })
                .catch(error => {
                    console.error('Network or parsing error:', error);
                    showNotification('Error deleting offering: ' + error.message, false);
                });
            }

            // Update the deletion handler
            document.addEventListener('click', function(e) {
                if (e.target.closest('.delete-offering-button')) {
                    const card = e.target.closest('.service-card');
                    if (card) {
                        if (confirm('Are you sure you want to delete this offering?')) {
                            // Get the form
                            const form = document.getElementById('work-with-me-form');
                            
                            // Get the ID field before removing the card
                            const idField = card.querySelector('input[name$="-id"]');
                            const idValue = idField ? idField.value : null;
                            
                            // Ensure management form fields exist
                            if (!form.querySelector('[name="work_with_me-TOTAL_FORMS"]')) {
                                const managementFields = `
                                    <input type="hidden" name="work_with_me-TOTAL_FORMS" value="${form.querySelectorAll('.service-card').length}">
                                    <input type="hidden" name="work_with_me-INITIAL_FORMS" value="${form.querySelectorAll('.service-card input[name$="-id"][value]').length}">
                                    <input type="hidden" name="work_with_me-MIN_NUM_FORMS" value="0">
                                    <input type="hidden" name="work_with_me-MAX_NUM_FORMS" value="1000">
                                `;
                                form.insertAdjacentHTML('afterbegin', managementFields);
                            }

                            if (idValue) {
                                // Handle existing record deletion
                                const deleteField = document.createElement('input');
                                deleteField.type = 'hidden';
                                deleteField.name = `work_with_me-${card.getAttribute('data-row-id')-1}-DELETE`;
                                deleteField.value = 'on';
                                
                                const preservedIdField = document.createElement('input');
                                preservedIdField.type = 'hidden';
                                preservedIdField.name = `work_with_me-${card.getAttribute('data-row-id')-1}-id`;
                                preservedIdField.value = idValue;
                                
                                form.appendChild(preservedIdField);
                                form.appendChild(deleteField);
                                
                                // Submit form to delete existing record
                                submitWorkWithMeFormAfterDeletion(form, card);
                            } else {
                                // For new/empty cards, just remove from DOM and update indexes
                                card.remove();
                                
                                // Update the TOTAL_FORMS count
                                const totalFormsInput = form.querySelector('[name="work_with_me-TOTAL_FORMS"]');
                                const remainingCards = form.querySelectorAll('.service-card').length;
                                if (totalFormsInput) {
                                    totalFormsInput.value = remainingCards;
                                }
                                
                                // Update indexes for remaining cards
                                updateWorkWithMeIndexes(form);
                            }
                        }
                    }
                }
            });

            // Helper function to update Work With Me indexes
            function updateWorkWithMeIndexes(form) {
                const cards = form.querySelectorAll('.service-card');
                cards.forEach((card, index) => {
                    card.setAttribute('data-row-id', index + 1);
                    card.querySelectorAll('[name*="work_with_me-"]').forEach(input => {
                        const oldIndex = input.name.match(/work_with_me-(\d+)-/)[1];
                        input.name = input.name.replace(
                            `work_with_me-${oldIndex}-`,
                            `work_with_me-${index}-`
                        );
                        if (input.id) {
                            input.id = input.id.replace(
                                `work_with_me-${oldIndex}-`,
                                `work_with_me-${index}-`
                            );
                        }
                    });
                });
            }

            // Update form submission handler
            document.getElementById('work-with-me-form')?.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Create FormData object
                const formData = new FormData(this);
                
                // Debug log to check form data
                console.log('Form Data:');
                for (let pair of formData.entries()) {
                    console.log(pair[0] + ': ' + pair[1]);
                }
                
                // Ensure we have the correct section identifier
                formData.set('section', 'work_with_me');
                
                // Get current counts
                const totalCards = this.querySelectorAll('.service-card').length;
                const initialCards = this.querySelectorAll('.service-card input[name$="-id"][value]').length;
                
                // Set management form data
                formData.set('work_with_me-TOTAL_FORMS', totalCards.toString());
                formData.set('work_with_me-INITIAL_FORMS', initialCards.toString());
                formData.set('work_with_me-MIN_NUM_FORMS', '0');
                formData.set('work_with_me-MAX_NUM_FORMS', '1000');
                
                console.log('Submitting Work With Me form:', {
                    totalForms: formData.get('work_with_me-TOTAL_FORMS'),
                    initialForms: formData.get('work_with_me-INITIAL_FORMS'),
                    section: formData.get('section'),
                    allData: Object.fromEntries(formData.entries())
                });

                // Submit the form
                fetch(window.location.href, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': this.querySelector('[name="csrfmiddlewaretoken"]').value
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification('Work With Me section saved successfully!');
                    } else {
                        console.error('Server returned error:', data);
                        showNotification(data.error || 'Error saving Work With Me section', false);
                    }
                })
                .catch(error => {
                    console.error('Network or parsing error:', error);
                    showNotification('Error saving Work With Me section: ' + error.message, false);
                });
            });

            // Make sure management form fields are initialized on page load
            document.addEventListener('DOMContentLoaded', function() {
                const workWithMeForm = document.getElementById('work-with-me-form');
                if (workWithMeForm) {
                    // Initialize or update management form fields
                    const totalCards = workWithMeForm.querySelectorAll('.service-card').length;
                    const initialCards = workWithMeForm.querySelectorAll('.service-card input[name$="-id"][value]').length;
                    
                    // Update or create management form fields
                    const managementFields = {
                        'work_with_me-TOTAL_FORMS': totalCards,
                        'work_with_me-INITIAL_FORMS': initialCards,
                        'work_with_me-MIN_NUM_FORMS': 0,
                        'work_with_me-MAX_NUM_FORMS': 1000
                    };
                    
                    Object.entries(managementFields).forEach(([name, value]) => {
                        let input = workWithMeForm.querySelector(`[name="${name}"]`);
                        if (!input) {
                            input = document.createElement('input');
                            input.type = 'hidden';
                            input.name = name;
                            workWithMeForm.insertBefore(input, workWithMeForm.firstChild);
                        }
                        input.value = value;
                    });
                    
                    console.log('Initialized Work With Me form management fields:', managementFields);
                }
            });

            // Handle Gallery item deletion
            document.addEventListener('click', function(e) {
                if (e.target.closest('.delete-gallery-button')) {
                    e.stopPropagation();
                    const card = e.target.closest('.gallery-card');
                    if (card && confirm('Are you sure you want to delete this gallery item?')) {
                        const form = document.getElementById('gallery-form');
                        const idInput = card.querySelector('input[name$="-id"]');
                        const index = parseInt(card.getAttribute('data-row-id')) - 1;
                        
                        // For existing items with an ID
                        if (idInput && idInput.value) {
                            // Create a minimal form with just the necessary fields for deletion
                            const formData = new FormData();
                            formData.append('csrfmiddlewaretoken', form.querySelector('[name="csrfmiddlewaretoken"]').value);
                            formData.append('section', 'gallery');
                            formData.append(`gallery-${index}-id`, idInput.value);
                            formData.append(`gallery-${index}-DELETE`, 'on');
                            formData.append('gallery-TOTAL_FORMS', '1');
                            formData.append('gallery-INITIAL_FORMS', '1');
                            formData.append('gallery-MIN_NUM_FORMS', '0');
                            formData.append('gallery-MAX_NUM_FORMS', '1000');
                            
                            fetch(window.location.href, {
                                method: 'POST',
                                body: formData,
                                headers: {
                                    'X-CSRFToken': form.querySelector('[name="csrfmiddlewaretoken"]').value
                                }
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    card.remove();
                                    updateGalleryIndexes();
                                    showNotification('Gallery item deleted successfully');
                                } else {
                                    showNotification(data.error || 'Error deleting gallery item', false);
                                    console.error('Form errors:', data.form_errors);
                                }
                            })
                            .catch(error => {
                                console.error('Error:', error);
                                showNotification('Error deleting gallery item', false);
                            });
                        } else {
                            // For new items without an ID, just remove from DOM
                            card.remove();
                            updateGalleryIndexes();
                        }
                    }
                }
            });

            // Update the gallery form submission handler
            document.getElementById('gallery-form')?.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Remove empty forms before submission
                const cards = this.querySelectorAll('.gallery-card');
                cards.forEach(card => {
                    const platformInput = card.querySelector('select[name$="-platform"]');
                    const urlInput = card.querySelector('input[name$="-example_url"]');
                    
                    if ((!platformInput?.value || !urlInput?.value) && 
                        !card.querySelector('input[name$="-DELETE"]')) {
                        card.remove();
                    }
                });
                
                // Update indexes after removing empty forms
                updateGalleryIndexes();
                
                const formData = new FormData(this);
                
                fetch(window.location.href, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': this.querySelector('[name="csrfmiddlewaretoken"]').value
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification('Gallery updated successfully');
                    } else {
                        showNotification(data.error || 'Error updating gallery', false);
                        console.error('Form errors:', data.form_errors);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showNotification('Error updating gallery', false);
                });
            });

            // Add Brand Partner
            document.getElementById('add-brand-partner-button')?.addEventListener('click', function() {
                const container = document.querySelector('.partners-container');
                const totalForms = document.querySelector('#brand-partners-form [name$="-TOTAL_FORMS"]');
                const newIndex = parseInt(totalForms.value);
                
                const template = `
                    <div class="partner-row" data-row-id="${newIndex + 1}">
                        <input type="hidden" name="form-${newIndex}-id" id="id_form-${newIndex}-id" value="">
                        <div class="separator"></div>
                        <div class="partner-content">
                            <div class="partner-fields">
                                <div class="form-group">
                                    <label for="id_form-${newIndex}-name">Brand Name</label>
                                    <input type="text" name="form-${newIndex}-name" id="id_form-${newIndex}-name">
                                </div>
                                <div class="form-group">
                                    <label for="id_form-${newIndex}-logo">Brand Logo</label>
                                    <input type="file" name="form-${newIndex}-logo" id="id_form-${newIndex}-logo">
                                </div>
                                <div class="form-group">
                                    <label for="id_form-${newIndex}-integration_url">Integration URL</label>
                                    <input type="url" name="form-${newIndex}-integration_url" id="id_form-${newIndex}-integration_url">
                                </div>
                            </div>
                            <button type="button" class="delete-brand-partner-button" data-row-id="${newIndex + 1}">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M3 6H5H21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M19 6V20C19 20.5304 18.7893 21.0391 18.4142 21.4142C18.0391 21.7893 17.5304 22 17 22H7C6.46957 22 5.96086 21.7893 5.58579 21.4142C5.21071 21.0391 5 20.5304 5 20V6M8 6V4C8 3.46957 8.21071 2.96086 8.58579 2.58579C8.96086 2.21071 9.46957 2 10 2H14C14.5304 2 15.0391 2.21071 15.4142 2.58579C15.7893 2.96086 16 3.46957 16 4V6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                `;
                
                container.insertAdjacentHTML('beforeend', template);
                totalForms.value = newIndex + 1;
            });

            // Add Social Platform
            document.getElementById('add-platform-button')?.addEventListener('click', function() {
                const container = document.getElementById('social-platforms-container');
                const totalForms = document.querySelector('#social-platforms-form [name$="-TOTAL_FORMS"]');
                const newIndex = parseInt(totalForms.value);
                
                const template = `
                    <div class="form-row social-platform-row" data-row-id="${newIndex + 1}">
                        <div class="form-group">
                            <label for="id_form-${newIndex}-platform">Platform</label>
                            <select name="form-${newIndex}-platform" id="id_form-${newIndex}-platform">
                                <option value="">---------</option>
                                <option value="YOUTUBE">YouTube</option>
                                <option value="INSTAGRAM">Instagram</option>
                                <option value="TIKTOK">TikTok</option>
                                <option value="TWITTER">Twitter</option>
                                <option value="FACEBOOK">Facebook</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="id_form-${newIndex}-followers">Followers</label>
                            <input type="number" name="form-${newIndex}-followers" id="id_form-${newIndex}-followers">
                        </div>
                        <div class="form-group">
                            <label for="id_form-${newIndex}-engagement_rate">Engagement Rate (%)</label>
                            <input type="number" step="0.01" name="form-${newIndex}-engagement_rate" id="id_form-${newIndex}-engagement_rate">
                        </div>
                        <button type="button" class="delete-platform-button" data-row-id="${newIndex + 1}">Delete</button>
                    </div>
                `;
                
                container.insertAdjacentHTML('beforeend', template);
                totalForms.value = newIndex + 1;
            });

            // Update the Add Work With Me Offering button handler
            document.getElementById('add-offering-button')?.addEventListener('click', function() {
                const container = document.getElementById('work-with-me-container');
                const totalForms = document.querySelector('#work-with-me-form [name="work_with_me-TOTAL_FORMS"]');
                const newIndex = parseInt(totalForms.value);
                
                const template = `
                    <div class="service-card" data-row-id="${newIndex + 1}">
                        <div class="service-card-header">
                            <div class="service-card-grid">
                                <div class="form-group">
                                    <label for="id_work_with_me-${newIndex}-platform">Platform</label>
                                    <select name="work_with_me-${newIndex}-platform" id="id_work_with_me-${newIndex}-platform">
                                        <option value="">---------</option>
                                        <option value="YOUTUBE">YouTube</option>
                                        <option value="INSTAGRAM">Instagram</option>
                                        <option value="TIKTOK">TikTok</option>
                                        <option value="TWITTER">Twitter</option>
                                        <option value="FACEBOOK">Facebook</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="id_work_with_me-${newIndex}-offering">Offering</label>
                                    <input type="text" name="work_with_me-${newIndex}-offering" id="id_work_with_me-${newIndex}-offering">
                                </div>
                            </div>
                        </div>
                        <div class="service-card-content">
                            <div class="form-group">
                                <label for="id_work_with_me-${newIndex}-service_description">Service Description</label>
                                <textarea name="work_with_me-${newIndex}-service_description" id="id_work_with_me-${newIndex}-service_description"></textarea>
                            </div>
                            <div class="service-card-grid-three">
                                <div class="form-group">
                                    <label for="id_work_with_me-${newIndex}-price">Price</label>
                                    <input type="number" name="work_with_me-${newIndex}-price" id="id_work_with_me-${newIndex}-price">
                                </div>
                                <div class="form-group">
                                    <label for="id_work_with_me-${newIndex}-number_of_deliverables">Number of Deliverables</label>
                                    <input type="number" name="work_with_me-${newIndex}-number_of_deliverables" id="id_work_with_me-${newIndex}-number_of_deliverables">
                                </div>
                                <div class="form-group">
                                    <label for="id_work_with_me-${newIndex}-length_of_deliverables">Length (seconds)</label>
                                    <input type="number" name="work_with_me-${newIndex}-length_of_deliverables" id="id_work_with_me-${newIndex}-length_of_deliverables">
                                </div>
                            </div>
                        </div>
                        <div class="service-card-footer">
                            <button type="button" class="delete-offering-button" data-row-id="${newIndex + 1}">
                                <svg viewBox="0 0 24 24" width="16" height="16">
                                    <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                `;
                
                container.insertAdjacentHTML('beforeend', template);
                totalForms.value = newIndex + 1;
            });

            // Add Gallery Item
            document.getElementById('add-gallery-button')?.addEventListener('click', function() {
                const container = document.getElementById('gallery-container');
                const totalForms = document.querySelector('#gallery-form [name$="-TOTAL_FORMS"]');
                const newIndex = parseInt(totalForms.value);
                
                const template = `
                    <div class="gallery-card" data-row-id="${newIndex + 1}">
                        <div class="gallery-grid">
                            <div class="form-group">
                                <label for="id_form-${newIndex}-platform">Platform</label>
                                <div class="platform-display">
                                    <span class="platform-icon"></span>
                                    <select name="form-${newIndex}-platform" id="id_form-${newIndex}-platform">
                                        <option value="">---------</option>
                                        <option value="YOUTUBE">YouTube</option>
                                        <option value="INSTAGRAM">Instagram</option>
                                        <option value="TIKTOK">TikTok</option>
                                        <option value="TWITTER">Twitter</option>
                                        <option value="FACEBOOK">Facebook</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group url-group">
                                <label for="id_form-${newIndex}-example_url">Content URL</label>
                                <div class="url-container">
                                    <input type="url" name="form-${newIndex}-example_url" id="id_form-${newIndex}-example_url">
                                    <button type="button" class="copy-button" title="Copy URL">
                                        <svg viewBox="0 0 24 24" width="16" height="16">
                                            <path d="M8 4v12a2 2 0 002 2h8a2 2 0 002-2V7.242a2 2 0 00-.602-1.43L16.083 2.57A2 2 0 0014.685 2H10a2 2 0 00-2 2z" stroke="currentColor" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <div class="form-group priority-group">
                                <label for="id_form-${newIndex}-video_priority">Priority</label>
                                <div class="priority-display">
                                    <svg viewBox="0 0 24 24" width="16" height="16">
                                        <circle cx="12" cy="12" r="10" stroke="currentColor" fill="none" stroke-width="2"/>
                                        <path d="M12 6v6l4 2" stroke="currentColor" fill="none" stroke-width="2" stroke-linecap="round"/>
                                    </svg>
                                    <input type="number" name="form-${newIndex}-video_priority" id="id_form-${newIndex}-video_priority">
                                </div>
                            </div>
                            <button type="button" class="delete-gallery-button" data-row-id="${newIndex + 1}">
                                <svg viewBox="0 0 24 24" width="16" height="16">
                                    <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                `;
                
                container.insertAdjacentHTML('beforeend', template);
                totalForms.value = newIndex + 1;
            });

            // Update the gallery form submission handler
            document.getElementById('gallery-form')?.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Get all gallery cards
                const cards = this.querySelectorAll('.gallery-card');
                const totalFormsInput = this.querySelector('[name="gallery-TOTAL_FORMS"]');
                const initialFormsInput = this.querySelector('[name="gallery-INITIAL_FORMS"]');
                
                // Update form counts
                totalFormsInput.value = cards.length;
                
                // Create FormData object
                const formData = new FormData(this);
                
                // Debug log
                console.log('Submitting form data:');
                for (let pair of formData.entries()) {
                    console.log(pair[0], pair[1]);
                }
                
                fetch(window.location.href, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': this.querySelector('[name="csrfmiddlewaretoken"]').value
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification('Gallery updated successfully');
                        // Optionally reload to show updated state
                        window.location.reload();
                    } else {
                        showNotification(data.error || 'Error updating gallery', false);
                        console.error('Form errors:', data.form_errors);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showNotification('Error updating gallery', false);
                });
            });

            // Update the updateGalleryIndexes function
            function updateGalleryIndexes() {
                const form = document.getElementById('gallery-form');
                const cards = form.querySelectorAll('.gallery-card');
                const totalFormsInput = form.querySelector('[name="gallery-TOTAL_FORMS"]');
                
                // Update total forms count
                totalFormsInput.value = cards.length;
                
                // Update indexes for all cards
                cards.forEach((card, index) => {
                    card.setAttribute('data-row-id', index + 1);
                    card.querySelectorAll('[name*="gallery-"]').forEach(input => {
                        const oldName = input.name;
                        const newName = oldName.replace(/gallery-\d+/, `gallery-${index}`);
                        input.name = newName;
                        if (input.id) {
                            input.id = input.id.replace(/gallery-\d+/, `gallery-${index}`);
                        }
                    });
                });
            }
        });

        // Add this to your existing DOMContentLoaded event listener
        function toggleSection(header) {
            const card = header.closest('.card');
            card.classList.toggle('collapsed');
            
            // Save state to localStorage
            const sectionId = card.querySelector('section')?.id || card.id;
            if (sectionId) {
                localStorage.setItem(
                    `section_${sectionId}_collapsed`,
                    card.classList.contains('collapsed')
                );
            }
        }

        // Initialize collapse state from localStorage
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.card').forEach(card => {
                const sectionId = card.querySelector('section')?.id || card.id;
                if (sectionId) {
                    const isCollapsed = localStorage.getItem(`section_${sectionId}_collapsed`) === 'true';
                    if (isCollapsed) {
                        card.classList.add('collapsed');
                    }
                }
            });
        });
    </script>

